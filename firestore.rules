rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);

      // User settings subcollection
      match /settings/{settingId} {
        allow read, write: if isOwner(userId);
      }

      // User favorites subcollection
      match /favorites/{favoriteId} {
        allow read, write: if isOwner(userId);
      }
    }

    // Attendance records (직관 기록)
    match /attendance_records/{recordId} {
      // 모든 인증된 사용자가 읽기 가능 (프로필 보기용)
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Match diary (직관 일기)
    match /match_diary/{diaryId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Schedules (경기 일정) - read only for authenticated users
    match /schedules/{scheduleId} {
      allow read: if isAuthenticated();
    }

    // Notification settings (알림 설정)
    match /notification_settings/{settingId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Teams (팀 정보) - read only
    match /teams/{teamId} {
      allow read: if isAuthenticated();
    }

    // Players (선수 정보) - read and create for authenticated users
    match /players/{playerId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
    }

    // Community Posts (커뮤니티 게시글)
    match /posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.authorId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.authorId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.authorId == request.auth.uid;
    }

    // Comments (댓글)
    match /comments/{commentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.authorId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.authorId == request.auth.uid;
    }

    // Likes (좋아요)
    match /likes/{likeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
  }
}
